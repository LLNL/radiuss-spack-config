##############################################################################
# Copyright (c) 2021, Lawrence Livermore National Security, LLC and
# RADIUSS Stack project contributors. See the LICENSE file for details.
#
# SPDX-License-Identifier: MIT
##############################################################################

spack:
  #[general--]
  include: [$SYS_TYPE]
  concretizer:
    unify: false
  view: false
  #[--general]

  #[config-override--]
  config:
    install_tree:
      root: /usr/workspace/radiuss/install/bradiuss
      padded_length: 128
      projections:
        all: '{architecture}/{compiler.name}-{compiler.version}/{name}-{version}-{hash}'
    'build_stage:':
    - $user_cache_path/stage
    test_stage: $user_cache_path/test
    misc_cache: $user_cache_path/misc
    flags:
      keep_werror: all
  #[--config-override]

  mirrors:
    radiuss:
      url: file:///usr/workspace/radiuss/mirrors/bradiuss
      signed: false
    gitlab_ci:
      url: 'oci://czregistry.llnl.gov:5050/radiuss/radiuss-spack-testing'
      access_pair:
      - $CI_REGISTRY_USER
      - $CI_JOB_TOKEN
      signed: false

  #[definitions--]
  definitions:
  - compilers:
    - '%gcc@=10.3.1'
    - '%clang@=14.0.6'
    when: env.get("SYS_TYPE", "") == "toss_4_x86_64_ib"
  - compilers:
    - '%xl@=16.1.1.12.gcc.8.3.1'
    when: env.get("SYS_TYPE", "") == "blueos_3_ppc64le_ib_p9"
  #[definitions--]

  - radiuss-projects:
    - mfem
    - hypre
    - sundials
    - samrai
    - xbraid
    - umpire
    - raja
    - py-maestrowf
    - conduit
    - zfp
    - axom
    - caliper
    - ascent
    - scr
    when: env.get("SYS_TYPE", "") == "toss_4_x86_64_ib"
  - radiuss-projects:
    - mfem
    - hypre
    - sundials
    - samrai
    - xbraid
    - umpire
    - raja
    - py-maestrowf
    - conduit
    - zfp
    - axom
    - caliper
    - ascent
    - scr
    when: env.get("SYS_TYPE", "") == "blueos_3_ppc64le_ib_p9"
  - dependencies: []
  #[--definitions]

  specs:
  - matrix:
    - [$radiuss-projects, $dependencies]
    - [$compilers]
    exclude: []

  ci:
    target: gitlab
    pipeline-gen:
    - submapping:
      - match:
        - target=cascadelake
        build-job:
          tags: [ruby, shell]
          script:
          - . ${MY_SPACK_PATH}/share/spack/setup-env.sh
          - export SPACK_DISABLE_LOCAL_CONFIG=""
          - export SPACK_USER_CACHE_PATH="${MY_SPACK_USER_CACHE}"
          - cd ${SPACK_CONCRETE_ENV_DIR} && spack env activate --without-view .
          - spack -d ci rebuild

      # lassen
      - match:
        - 'target=ppc64le:'
        build-job:
          tags: [lassen, shell]
          script:
          - . ${MY_SPACK_PATH}/share/spack/setup-env.sh
          - export SPACK_DISABLE_LOCAL_CONFIG=""
          - export SPACK_USER_CACHE_PATH="${SPACK_USER_CACHE}"
          - cd ${SPACK_CONCRETE_ENV_DIR} && spack env activate --without-view .
          - spack -d ci rebuild

      match_behavior: first
    - reindex-job:
        tags: [oslic, shell]
        before_script:
        - . ${MY_SPACK_PATH}/share/spack/setup-env.sh

    - noop-job:
        tags: [oslic, shell]
        before_script:
        - . ${MY_SPACK_PATH}/share/spack/setup-env.sh

    - cleanup-job:
        tags: [oslic, shell]
        before_script:
        - . ${MY_SPACK_PATH}/share/spack/setup-env.sh

